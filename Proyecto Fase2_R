library(arules)
library(ggplot2)
library(readxl)
library(utf8)
library(tidyverse)
library(janitor)
library(rpart)
library(rpart.plot)


ruta <- "C:\\Users\\Daniel\\Downloads\\data"   
archivos <- list.files(ruta, pattern = "\\.xlsx$", full.names = TRUE)

leer_limpio <- function(path){
  read_excel(path) |> 
    clean_names() |> 
    mutate(source_file = basename(path))
}
base_unificada <- map_dfr(archivos, leer_limpio)

base_unificada <- base_unificada |>
  mutate(
    ano = as.integer(ano),
    mes = as.character(mes),
    edad = as.integer(edad)
  ) |>
  distinct()

datos <- select(base_unificada, -last_col())

data <- datos %>%
  rename(
    pueblo_pertenencia = ppertenencia,
    periodo_edad = periodoeda,
    municipio_residencia = muniresiden,
    tipo_consulta = tc,
    causa_atencion = caufin
    
  )

#PARTE 1 ARBOLES DE DECISION
#Caso 1: Emergencias en la capital - Rinofaringitis aguda [resfriado común]
datos_mayores_emergencias <- subset(data, tipo_consulta == 3)
datos_mayores_emergencias <- subset(datos_mayores_emergencias, deptoresiden == 1)
datos_mayores_emergencias <- subset(datos_mayores_emergencias, causa_atencion != 'A099')
arbol1 <- rpart( causa_atencion ~ 
                   edad +
                   mes+
                   sexo,
                 data = datos_mayores_emergencias, method = "class"
)
rpart.plot(arbol1, type = 2, extra =0, under = TRUE, fallen.leaves =TRUE, box.palette ="BuGn",
           main ="causa de atencion", cex = 0.5
           
)
#Una mujer con edad de 25 y que se haya enfermado en octubre
persona1 <- data.frame(
  edad = 25,
  mes  = factor("10", levels = levels(datos_mayores_emergencias$mes)),
  sexo = 2
)

result1 <- predict(arbol1, persona1,  type = "prob")
sort(result1[1, ], decreasing = TRUE)[1:10] #Escoger solo el top 10 de casos

#Hombre de 10 años, enfermo en julio
persona2 <- data.frame(
  edad = 10,
  mes  = factor("7", levels = levels(datos_mayores_emergencias$mes)),
  sexo = 1
)

result2 <- predict(arbol1, persona2,  type = "prob")
sort(result2[1, ], decreasing = TRUE)[1:10] #Escoger solo el top 10 de casos

#Mujer de 5 años, enferma en enero
persona3 <- data.frame(
  edad = 5,
  mes  = factor("1", levels = levels(datos_mayores_emergencias$mes)),
  sexo = 2
)

result3 <- predict(arbol1, persona3,  type = "prob")
sort(result3[1, ], decreasing = TRUE)[1:10] #Escoger solo el top 10 de casos


#Caso 2 para Gastroenteritis y colitis de origen no especificado
datos_gastro <- subset(data, causa_atencion ==  "A099")
datos_gastro <- datos_gastro[,c("edad","mes","deptoresiden","tipo_consulta")]

arbol2 <- rpart( tipo_consulta ~ 
                   edad +
                   mes+
                   deptoresiden,
                 data = datos_gastro, method = "class"
)
rpart.plot(arbol2, type = 2, extra =0, under = TRUE, fallen.leaves =TRUE, box.palette ="BuGn",
           main ="Tipo de consulta", cex = 0.5
           
)
#Joven de 15 años, con consulta hecha en noviembre y en suchitepequez
persona_g1 <- data.frame(
  edad = 15,
  mes  = factor("11", levels = levels(datos_gastro$mes)),
  deptoresiden = 11
)

result <- predict(arbol2, persona_g1,  type = "prob")
result

#Adulto de 54 años, con consulta hecha en marzo y en Peten
persona_g2 <- data.frame(
  edad = 54,
  mes  = factor("3", levels = levels(datos_gastro$mes)),
  deptoresiden = 22
)

result <- predict(arbol2, persona_g1,  type = "prob")
result

#Caso 3: La enfermedad de Acné vulgar en relación con el pueblo Xinka, el sexo y el tipo de consulta
datos_xinka <- data %>%
  transmute(
    causa = ifelse(causa_atencion == "L700", 1, 0),
    sexo,
    pueblo_pertenencia,
    tipo_consulta
  ) %>%
  na.omit()

datos_xinka$causa <- factor(datos_xinka$causa, levels = c(0,1),
                            labels = c("No_L700","Si_L700"))

table(datos_xinka$causa)
set.seed(123)

idx_1  <- which(datos_xinka$causa == "Si_L700")
idx_0  <- which(datos_xinka$causa == "No_L700")


n_1 <- length(idx_1)
n_0_mostrar <- min(length(idx_0), n_1 * 4)

idx_0_sub <- sample(idx_0, n_0_mostrar)

datos_bal <- datos_xinka[c(idx_1, idx_0_sub), ]

table(datos_bal$causa)

arbol3 <- rpart(
  causa ~ pueblo_pertenencia + sexo + tipo_consulta,
  data   = datos_bal,
  method = "class",
  control = rpart.control(minbucket = 50, cp = 0.001)  
)

rpart.plot(arbol3, type = 2, extra =0, under = TRUE, fallen.leaves =TRUE, box.palette ="BuGn",
           main ="Causa", cex = 0.5)

#Mujer, del pueblo xinka y reconsulta
persona_x1 <- data.frame(
  tipo_consulta = c(2),
  pueblo_pertenencia = c(3),
  sexo = c(2)
)

result <- predict(arbol3, persona_x1,  type = "prob")
result

#Hombre, del pueblo xinka y reconsulta
persona_x1 <- data.frame(
  tipo_consulta = c(2),
  pueblo_pertenencia = c(3),
  sexo = c(1)
)

result <- predict(arbol3, persona_x1,  type = "prob")
result

#Mujer, del pueblo maya y reconsulta
persona_x1 <- data.frame(
  tipo_consulta = c(2),
  pueblo_pertenencia = c(1),
  sexo = c(1)
)

result <- predict(arbol3, persona_x1,  type = "prob")
result


#Caso 4: Relación de las emergencias con el pueblo donde sucede, el sexo y el pueblo de pertenencia
datos_emergencia <- data %>%
  transmute(
    consulta = ifelse(tipo_consulta == "3", 1, 0),
    sexo,
    pueblo_pertenencia,
    deptoresiden
  ) %>%
  na.omit()

datos_emergencia$consulta <- factor(datos_emergencia$consulta, levels = c(0,1),
                            labels = c("No_3","Si_3"))

table(datos_emergencia$consulta)
set.seed(123)

idx_1  <- which(datos_emergencia$consulta == "Si_3")
idx_0  <- which(datos_emergencia$consulta == "No_3")


n_1 <- length(idx_1)
n_0_mostrar <- min(length(idx_0), n_1 * 4)

idx_0_sub <- sample(idx_0, n_0_mostrar)

datos_bal_emer <- datos_emergencia[c(idx_1, idx_0_sub), ]

table(datos_bal_emer$consulta)


arbol4 <- rpart(
  consulta ~ pueblo_pertenencia + sexo + deptoresiden,
  data   = datos_bal_emer,
  method = "class",
  control = rpart.control(minbucket = 50, cp = 0.001)  
)

rpart.plot(arbol4, type = 2, extra =0, under = TRUE, fallen.leaves =TRUE, box.palette ="BuGn",
           main ="Consulta", cex = 0.4)


